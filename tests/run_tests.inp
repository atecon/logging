set verbose off
clear

set assert stop
include assertion.gfn

include "./src/logging.inp" --force


set logstamp FALSE          # Timestamp is deactivated as we cannot mock it

# helper function
function void print_logs (void)
    Debug("This is a Debug message.")
    Info("This is a Info message.")
    Warn("This is a Warning message.")
    Error("This is a Error message.")
    Critical("This is a Critical message.")
end function



# FOR loglevel "debug"
set loglevel debug

bundle Expected = _(\
                    Debug="DEBUG: This is a Debug message.",\
                    Info="INFO: This is a Info message.",\
                    Warning="WARNING: This is a Warning message.",\
                    Error="ERROR: This is a Error message.",\
                    Critical="CRITICAL: This is a Critical message."\
                    )
bundle NotExpected

function void test_debug (const bundle Expected, const bundle NotExpected)
    print "Start testing loglevel 'debug'."

    string actual
    outfile --buffer=actual
        print_logs()
    end outfile

    loop foreach i Expected
        assert(instring(actual, Expected["$i"]) == TRUE)
    endloop

    loop foreach i NotExpected
        assert(instring(actual, Expected["$i"]) == FALSE)
    endloop
end function
test_debug(Expected, NotExpected)



# FOR loglevel "info"
set loglevel info

bundle Expected = _(\
                    Info="INFO: This is a Info message.",\
                    Warning="WARNING: This is a Warning message.",\
                    Error="ERROR: This is a Error message.",\
                    Critical="CRITICAL: This is a Critical message."\
                    )
bundle NotExpected = _(\
                       Debug="DEBUG: This is a Debug message.",
                       )

function void test_info (const bundle Expected, const bundle NotExpected)
    print "Start testing loglevel 'info'."

    string actual
    outfile --buffer=actual
        print_logs()
    end outfile

    loop foreach i Expected
        assert(instring(actual, Expected["$i"]) == TRUE)
    endloop

    loop foreach i NotExpected
        assert(instring(actual, Expected["$i"]) == FALSE)
    endloop
end function
test_info(Expected, NotExpected)



# FOR loglevel "warning"
set loglevel warning

bundle Expected = _(\
                    Warning="WARNING: This is a Warning message.",\
                    Error="ERROR: This is a Error message.",\
                    Critical="CRITICAL: This is a Critical message."\
                    )
bundle NotExpected = _(\
                       Debug="DEBUG: This is a Debug message.",\
                       Info="INFO: This is a Info message.",
                       )

function void test_warning (const bundle Expected, const bundle NotExpected)
    print "Start testing loglevel 'warning'."

    string actual
    outfile --buffer=actual
        print_logs()
    end outfile

    loop foreach i Expected
        assert(instring(actual, Expected["$i"]) == TRUE)
    endloop

    loop foreach i NotExpected
        assert(instring(actual, Expected["$i"]) == FALSE)
    endloop
end function
test_warning(Expected, NotExpected)



# FOR loglevel "error"
set loglevel error

bundle Expected = _(\
                    Error="ERROR: This is a Error message.",\
                    Critical="CRITICAL: This is a Critical message."\
                    )
bundle NotExpected = _(\
                       Debug="DEBUG: This is a Debug message.",\
                       Info="INFO: This is a Info message.",\
                       Warning="WARNING: This is a Warning message.",
                       )

function void test_error (const bundle Expected, const bundle NotExpected)
    print "Start testing loglevel 'error'."

    string actual
    outfile --buffer=actual
        print_logs()
    end outfile

    loop foreach i Expected
        assert(instring(actual, Expected["$i"]) == TRUE)
    endloop

    loop foreach i NotExpected
        assert(instring(actual, Expected["$i"]) == FALSE)
    endloop
end function
test_error(Expected, NotExpected)



# FOR loglevel "critical"
set loglevel critical

bundle Expected = _(\
                    Critical="CRITICAL: This is a Critical message."\
                    )
bundle NotExpected = _(\
                       Debug="DEBUG: This is a Debug message.",\
                       Info="INFO: This is a Info message.",\
                       Warning="WARNING: This is a Warning message.",\
                       Error="ERROR: This is a Error message.",\
                       )

function void test_critical (const bundle Expected, const bundle NotExpected)
    print "Start testing loglevel 'critical'."

    string actual
    outfile --buffer=actual
        print_logs()
    end outfile

    loop foreach i Expected
        assert(instring(actual, Expected["$i"]) == TRUE)
    endloop

    loop foreach i NotExpected
        assert(instring(actual, Expected["$i"]) == FALSE)
    endloop
end function
test_critical(Expected, NotExpected)




print "Finished all tests succesfully."
quit
